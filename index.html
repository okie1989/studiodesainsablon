


<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studio Desain Kaos</title>
    <!-- Favicon Kalkulator -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><path d='M11.5 2a1.5 1.5 0 1 0-3 0H7v3h10V2h-1.5ZM7 6h10v12a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6h4Zm2 2.5a.5.5 0 0 0-1 0v7a.5.5 0 0 0 1 0v-7Zm3 0a.5.5 0 0 0-1 0v7a.5.5 0 0 0 1 0v-7Zm3 0a.5.5 0 0 0-1 0v7a.5.5 0 0 0 1 0v-7Z'/></svg>" type="image/svg+xml">
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.6.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.6.0/firebase-database-compat.js"></script>

    
    <style>
:root {
    --primary-color: #4d8eff;
    --primary-hover: #3a7df5;
    --secondary-color: #7d8b94;
    --secondary-hover: #6c7a83;
    --background-color: #1a1a1a;
    --background-elevated: #252525;
    --background-elevated-2: #2e2e2e;
    --text-color: #ffffff;
    --text-secondary: #b0b0b0;
    --accent-color: #00c8ff;
    --success-color: #28a745;
    --border-radius: 12px;
    --box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    --transition-fast: all 0.15s ease-out;
}

body {
    font-family: "Exo 2", serif;
    max-width: 1400px;
    margin: 0 auto;
    padding: 30px;
    background-image: url(https://i.imgur.com/QBdh9bC.jpeg);
    color: var(--text-color);
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
}

.studio-container {
    display: grid;
    grid-template-columns: 320px 1fr;
    gap: 30px;
    height: 90vh;
    animation: fadeIn 0.5s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.controls-panel {
    background: #2525257a;
    padding: 6px;
    border-radius: var(--border-radius);
    overflow-y: auto;
    box-shadow: var(--box-shadow);
    border: 1px solid rgba(255, 255, 255, 0.05);
    scrollbar-width: thin;
    scrollbar-color: var(--primary-color) var(--background-elevated-2);
    max-height: fit-content;
}
.controls-panel::-webkit-scrollbar {
    width: 6px;
}

.controls-panel::-webkit-scrollbar-track {
    background: var(--background-elevated-2);
    border-radius: 3px;
}

.controls-panel::-webkit-scrollbar-thumb {
    background-color: var(--primary-color);
    border-radius: 3px;
}

.controls-section {
    margin-bottom: 6px;
    padding: 18px;
    background: var(--background-elevated-2);
    border-radius: var(--border-radius);
    transition: var(--transition);
    border-left: 3px solid transparent;
}

.controls-section:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    border-left-color: var(--primary-color);
    display: grid;
    justify-items: stretch;
}

.controls-section h3 {
    margin-bottom: 15px;
    color: var(--primary-color);
    font-weight: 600;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 8px;
}

.controls-section h3::before {
    content: "";
    display: inline-block;
    width: 8px;
    height: 8px;
    background: var(--primary-color);
    border-radius: 50%;
}

.input-group {
    margin-bottom: 15px;
    position: relative;
}

.input-group label {
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--text-secondary);
    font-size: 0.95rem;
    margin-bottom: 6px;
    transition: var(--transition-fast);
}

.input-group label:hover {
    color: var(--text-color);
}

input[type=file], input[type=color] {
    display: none;
}

input[type=number] {
    width: 120px;
    padding: 8px 10px;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 6px;
    color: var(--text-color);
    font-size: 0.95rem;
    transition: var(--transition-fast);
}

input[type=number]:focus {
    border-color: var(--primary-color);
    outline: none;
    box-shadow: 0 0 0 2px rgba(77, 142, 255, 0.2);
}

/* Tata Letak Warna */
.color-options {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    margin-top: 10px;
}

.color-swatch {
    width: 45px;
    height: 45px;
    border-radius: 10px;
    cursor: pointer;
    position: relative;
    transition: var(--transition);
}

.color-swatch::after {
    content: "";
    position: absolute;
    top: -3px;
    left: -3px;
    right: -3px;
    bottom: -3px;
    border: 2px solid transparent;
    border-radius: 12px;
    transition: var(--transition);
}

.color-swatch.selected::after {
    border-color: var(--primary-color);
}

.sleeve-select {
    background: var(--background-elevated-2);
    border: 1px solid rgba(255,255,255,0.1);
    color: var(--text-color);
    padding: 8px;
    border-radius: 6px;
    width: 100%;
    margin-top: 5px;
}

.preview-actions {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin-top: 25px;
    flex-wrap: wrap;
}

.preview-actions button {
    background: #2980b9;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
    margin: 5px;
}

.preview-actions button:hover {
    background: #3498db;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

button {
    background: var(--primary-color);
    color: #fff;
    border: none;
    padding: 10px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    transition: var(--transition);
    display: inline-flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    INLINE-SIZE: -WEBKIT-FILL-AVAILABLE;
}

button:hover {
    background: var(--primary-hover);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

button:active {
    transform: translateY(0);
}

button.secondary {
    background: var(--secondary-color);
}

button.secondary:hover {
    background: var(--secondary-hover);
}

button.icon-button {
    padding: 8px;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    display: inline-flex;
    justify-content: center;
    align-items: center;
}

.design-canvas {
    display: flex;
    flex-direction: column;
    gap: 20px;
    height: 120%;
    width: auto;
}

.mockup-frame {
    position: relative;
    background: var(--background-elevated-2);
    border-radius: var(--border-radius);
    overflow: hidden;
    flex: 0 0 36%;
    box-shadow: var(--box-shadow);
    transition: var(--transition);
    display: flex;
}

.mockup-frame:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 28px rgba(0, 0, 0, 0.4);
}

.mockup-frame img.mockup {
    width: 100%;
    height: 100%;
    object-fit: contain;
}

.overlay-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: auto;
}

.design-overlay {
    position: absolute;
    pointer-events: all;
    border: 2px dashed rgba(255, 255, 255, 0.5);
    transform-origin: center;
    display: block;
    transition: var(--transition-fast);
}

.design-overlay:hover {
    border-color: var(--accent-color);
    box-shadow: 0 0 0 2px rgba(0, 200, 255, 0.3);
}

.size-box-container {
    position: static;
    background: rgb(40 40 40 / 44%);
    border-radius: 10px;
    padding: 6px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
    z-index: 1000;
    border: 1px solid #555;
    backdrop-filter: blur(5px);
    transition: var(--transition);
    max-height: 97vh;
    overflow-y: auto;
}

/* Pastikan hanya ada satu size box yang terlihat */
.size-box-container:not(:first-child) {
    display: none !important;
}

.size-box-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid #555;
    font-weight: bold;
    font-size: 14px;
    cursor: pointer;
}




.size-box-grid {
    display: grid;
    gap: 12px;
}

.size-input-group {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.size-input-group label {
    font-size: 12px;
    color: #ccc;
}

.size-input-group input {
    padding: 6px 8px;
    background: #333;
    border: 1px solid #555;
    border-radius: 4px;
    color: #fff;
    font-size: 13px;
}

.size-input-group input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 1px var(--primary-color);
}

.position-controls {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
    margin: 8px 0;
}

.position-row {
    display: flex;
    gap: 8px;
    align-items: center;
}

.btn-nav {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: #444;
    border: none;
    color: white;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-nav:hover {
    background: #555;
    transform: scale(1.1);
}

.btn-center {
    background: var(--primary-color);
    width: 40px;
    height: 40px;
    font-size: 18px;
}

.btn-center:hover {
    background: var(--primary-hover);
}

.advanced-options {
    display: grid;
    gap: 8px;
    margin-top: 8px;
}

.option-checkbox {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    cursor: pointer;
}

.blend-mode-selector {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.blend-mode-selector label {
    font-size: 12px;
    color: #ccc;
}

.blend-mode-selector select {
    padding: 5px;
    background: #333;
    border: 1px solid #555;
    border-radius: 4px;
    color: #fff;
    font-size: 12px;
}

.btn-invert {
    padding: 6px 10px;
    background: #333;
    border: 1px solid #555;
    border-radius: 4px;
    color: #fff;
    font-size: 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s;
}

.btn-invert:hover {
    background: #444;
}

.btn-invert.active {
    background: var(--primary-color);
    border-color: var(--primary-hover);
}

.action-buttons {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin-top: 12px;
}

.btn-action {
    padding: 6px;
    background: #333;
    border: 1px solid #555;
    color: #fff;
    font-size: 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    transition: all 0.2s;
}

.btn-action:hover {
    background: #444;
}

.btn-action .icon {
    font-size: 14px;
}

.btn-delete {
    background: #5a1a1a;
    border-color: #7a2a2a;
}

.btn-delete:hover {
    background: #7a2a2a;
}

.size-box-confirm-btn {
    width: 100%;
    padding: 8px;
    margin-top: 8px;
    background: var(--success-color);
    font-size: 0.9rem;
    border: none;
    border-radius: 4px;
    color: white;
    cursor: pointer;
    transition: var(--transition-fast);
}

.size-box-confirm-btn:hover {
    background: #218838;
}

.price-display {
    background: var(--background-elevated-2);
    padding: 20px;
    border-radius: var(--border-radius);
    margin-top: auto;
    box-shadow: var(--box-shadow);
    border: 1px solid rgba(255, 255, 255, 0.05);
    transition: all 0.3s ease;
}

.price-display:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
}

.price-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.price-icon {
    font-size: 1.5rem;
    animation: pulse 2s infinite;
}

.price-header h3 {
    margin: 0;
    font-size: 1.1rem;
    color: var(--primary-color);
    text-transform: uppercase;
    letter-spacing: 1px;
}

.price-items {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 15px;
}

.price-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 10px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 6px;
    transition: all 0.2s ease;
}

.price-item:hover {
    background: rgba(0, 0, 0, 0.3);
    transform: translateX(5px);
}

.price-label {
    font-size: 0.9rem;
    color: var(--text-secondary);
}

.price-value {
    font-weight: 600;
    color: var(--accent-color);
}

.price-total {
    margin: 20px 0;
    padding: 15px;
    background: linear-gradient(135deg, rgba(77, 142, 255, 0.1), rgba(0, 200, 255, 0.1));
    border-radius: var(--border-radius);
    text-align: center;
    border: 1px solid rgba(0, 200, 255, 0.2);
    animation: glow 3s infinite alternate;
}

.total-label {
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-secondary);
    margin-bottom: 5px;
}

.total-amount {
    font-size: 1.8rem;
    font-weight: 800;
    color: var(--accent-color);
    text-shadow: 0 0 10px rgba(0, 200, 255, 0.3);
    transition: all 0.3s ease;
}

.preview-btn {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 12px;
    margin-top: 10px;
    background: var(--primary-color);
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.preview-btn:hover {
    background: var(--primary-hover);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

.btn-icon {
    border: none;
    border-radius: 4px;
    padding: 4px 8px;
    color: #eee;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-icon:hover {
    background: #444;
}

.btn-icon.active {
    background: var(--primary-color);
    color: white;
}

.btn-text {
    font-size: 0.95rem;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

@keyframes glow {
    from { box-shadow: 0 0 5px rgba(0, 200, 255, 0.1); }
    to { box-shadow: 0 0 15px rgba(0, 200, 255, 0.3); }
}
.preview-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.95);
    z-index: 2000;
    padding: 20px;
    box-sizing: border-box;
    animation: fadeIn 0.3s ease-out;
    overflow-y: auto;
}

.preview-content {
    background: var(--background-elevated);
    max-width: 90%;
    width: 900px;
    margin: 40px auto;
    padding: 30px;
    border-radius: var(--border-radius);
    position: relative;
    color: white;
    box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.05);
    animation: slideUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    max-height: calc(100vh - 80px);
    overflow-y: auto;
    
}


@keyframes slideUp {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.preview-images {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0px;
    margin: 25px 0;
    BORDER-RADIUS: 5PX;
}
.preview-image {
    position: relative;
    overflow: hidden;
    border-radius: 10px;
    transition: var(--transition);
}


.preview-image img {
    width: 100%;
    height: auto;
    object-fit: contain;
    display: block;
}

.preview-actions {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin-top: 25px;
}

.close-btn {
    position: absolute;
    right: 20px;
    top: 20px;
    cursor: pointer;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: var(--transition-fast);
    background: rgba(255, 255, 255, 0.1);
    z-index: 10;
}

.close-btn:hover {
    background: rgba(255, 255, 255, 0.2);
}







.price-detail-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    padding-bottom: 8px;
    border-bottom: 1px dashed rgba(255, 255, 255, 0.1);
}

.price-detail-item span:last-child {
    font-weight: 600;
    color: var(--accent-color);
}

.crop-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    z-index: 3000;
    padding: 20px;
    box-sizing: border-box;
    overflow: auto;
}

.crop-container {
    position: relative;
    max-width: 90%;
    width: 600px;
    margin: 20px auto;
    background: var(--background-elevated);
    padding: 20px;
    border-radius: var(--border-radius);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
}

.crop-wrapper {
    position: relative;
    margin: 0 auto;
    max-width: 100%;
    max-height: 60vh;
    overflow: auto;
    border-radius: 8px;
}

.crop-box {
    position: absolute;
    border: 2px dashed var(--accent-color);
    background-color: rgba(0, 200, 255, 0.1);
    cursor: move;
    box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7);
}

.crop-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 15px;
    align-items: center;
    justify-content: center;
}

.crop-controls button {
    padding: 8px 12px;
    font-size: 0.85rem;
}

.crop-input-group {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
}

.crop-input-group input {
    width: 60px;
    padding: 6px;
    text-align: center;
}

.price-summary {
    background: var(--background-elevated-2);
    border-radius: var(--border-radius);
    padding: 20px;
    margin: 20px 0;
    border: 1px solid rgba(255,255,255,0.1);
}

.price-detail {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 20px;
}

.price-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px dashed rgba(255,255,255,0.1);
}

.price-row:last-child {
    border-bottom: none;
}

.price-label {
    font-size: 0.95rem;
    color: var(--text-color);
}

.price-value {
    font-weight: 600;
    color: var(--accent-color);
}

.size-info {
    font-size: 0.8rem;
    color: var(--text-secondary);
    margin-left: 5px;
}

.price-total {
    background: linear-gradient(135deg, rgba(77,142,255,0.1), rgba(0,200,255,0.1));
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    margin-top: 25px;
    border: 1px solid rgba(0,200,255,0.2);
}

.total-label {
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin-bottom: 5px;
}

.total-amount {
    font-size: 1.8rem;
    font-weight: 800;
    color: var(--accent-color);
    margin: 10px 0;
}

.total-note {
    font-size: 0.75rem;
    color: var(--text-secondary);
    opacity: 0.8;
}

.combined-btn {
    background: #064236;
    color: #2ae295;
    border: none;
    padding: 10px 15px;
    border-radius: 6px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    margin-top: 10px;
    width: 100%;
    PLACE-CONTENT: CENTER;
}

.combined-btn:hover {
    background: #076448;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

/* Tooltip styles */
.tooltip {
    position: relative;
    display: inline-block;
}

.tooltip .tooltiptext {
    visibility: hidden;
    width: 180px;
    background-color: rgba(0, 0, 0, 0.9);
    color: #fff;
    text-align: center;
    border-radius: 6px;
    padding: 8px;
    position: absolute;
    z-index: 1;
    bottom: 125%;
    left: 50%;
    transform: translateX(-50%);
    opacity: 0;
    transition: opacity 0.3s;
    font-size: 0.85rem;
    backdrop-filter: blur(5px);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.tooltip:hover .tooltiptext {
    visibility: visible;
    opacity: 1;
}

/* Responsive adjustments */
@media (max-width: 1200px) {
    .studio-container {
        grid-template-columns: 280px 1fr;
        gap: 20px;
    }
}

@media (max-width: 992px) {
    .studio-container {
        grid-template-columns: 1fr;
        height: auto;
    }
    
    .mockup-frame {
        flex: 0 0 300px;
    }
}

/* Loading animation */
@keyframes pulse {
    0% { opacity: 0.6; }
    50% { opacity: 1; }
    100% { opacity: 0.6; }
}

.loading {
    animation: pulse 1.5s infinite ease-in-out;
}
/* Responsive untuk modal */
@media (max-width: 768px) {
    .preview-content {
        max-width: 95%;
        padding: 20px;
        margin: 20px auto;
    }
    
    .preview-images {
        grid-template-columns: 1fr;
    }
}

/* Animasi tambahan */
@keyframes slideDown {
    from { transform: translateY(-20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

/* Tambahkan di bagian CSS */
.locked-input {
    position: relative;
    background: rgba(0,0,0,0.2) !important;
    border-color: rgba(255,255,255,0.05) !important;
    cursor: not-allowed;
}

.locked-input::after {
    content: "üîí";
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
}

.admin-btn {
    background: linear-gradient(135deg, #ff5e62, #ff9966);
    margin-top: 5px;
}

.login-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    z-index: 3000;
    align-items: center;
    justify-content: center;
}

.login-box {
    background: var(--background-elevated);
    padding: 30px;
    border-radius: var(--border-radius);
    width: 300px;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    animation: slideDown 0.3s ease-out;
}

.login-box h3 {
    margin-top: 0;
    color: var(--primary-color);
}

.login-box input {
    width: 100%;
    padding: 12px;
    margin: 15px 0;
    background: rgba(0,0,0,0.3);
    border: 1px solid var(--primary-color);
    border-radius: 6px;
    color: white;
    font-size: 1rem;
}

.login-box button {
    width: 100%;
    margin-top: 10px;
}

.error-message {
    color: #ff5e62;
    margin-top: 10px;
    font-size: 0.9rem;
    display: none;
}

/* Tambahkan di bagian CSS */
#preview-download-area {
    background: var(--background-elevated);
    padding: 30px;
    color: var(--text-color);
    font-family: "Exo 2", sans-serif;
    width: 1000px;
    max-width: 100%;
    box-sizing: border-box;
}
.preview-actions button:nth-child(2) {
    background: #27ae60;
}

.preview-actions button:nth-child(2):hover {
    background: #219a52;
}

#preview-download-header {
    text-align: center;
    font-weight: bold;
    font-size: 24px;
    margin-bottom: 20px;
    color: var(--primary-color);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

#preview-download-images {
    display: flex;
    gap: 30px;
    justify-content: center;
    margin-bottom: 25px;
    flex-wrap: wrap;
}

#preview-download-images img {
    max-width: 450px;
    width: 100%;
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

#preview-download-prices {
    background: var(--background-elevated-2);
    padding: 20px;
    border-radius: var(--border-radius);
    margin: 20px auto;
    max-width: 800px;
}

.price-download-row {
    display: grid;
    grid-template-columns: 1fr 1.5fr 1fr;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px dashed rgba(255, 255, 255, 0.1);
    color: var(--text-secondary);
    font-size: 15px;
}

.price-download-row:last-child {
    border-bottom: none;
    font-weight: 600;
    color: var(--accent-color);
    font-size: 1.05rem;
    padding-top: 10px;
    margin-top: 5px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

#preview-download-total {
    text-align: center;
    font-size: 20px;
    font-weight: bold;
    margin-top: 20px;
    color: var(--accent-color);
    padding: 15px;
    background: var(--background-elevated-2);
    border-radius: var(--border-radius);
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
}
.section-header {
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    background: var(--background-elevated-2);
    border-radius: 8px;
    transition: var(--transition-fast);
}

.section-header:hover {
    background: var(--background-elevated);
}

.collapse-icon {
    transition: transform 0.3s ease;
    font-size: 0.8rem;
    margin-left: 10px;
}

.collapsed .collapse-icon {
    transform: rotate(-90deg);
}

.size-box-content {
    transition: all 0.3s ease;
    overflow: hidden;
}

.size-box-container.collapsed .size-box-content {
    max-height: 0;
    padding: 0;
    margin: 0;
    opacity: 0;
}

.section-content {
    max-height: 500px;
    overflow: hidden;
    transition: all 0.3s ease-in-out;
}

.section-content.collapsed {
    max-height: 0;
    padding-top: 0;
    padding-bottom: 0;
    margin-top: 0;
    margin-bottom: 0;
    opacity: 0;
}
.color-swatch:hover {
    transform: scale(1.1);
    box-shadow: 0 0 10px rgba(255,255,255,0.2);
}

.color-swatch:hover::after {
    border-color: rgba(255,255,255,0.3);
}
.blend-options {
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px dashed rgba(255,255,255,0.1);
}

.blend-options label {
    font-size: 0.8rem;
    margin-right: 8px;
    color: var(--text-secondary);
}

.blend-select {
    flex-grow: 1;
    background: #222;
    border: 1px solid #444;
    color: #eee;
    border-radius: 3px;
    padding: 2px 4px;
    font-size: 12px;
}

.blend-select option {
    background: var(--background-elevated);
}

.preview-image {
    position: relative;
}

.image-options {
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px dashed rgba(255,255,255,0.1);
}

.image-options button {
    width: 100%;
    padding: 6px;
    margin-top: 5px;
    background: rgba(0,0,0,0.3);
    border: 1px solid var(--primary-color);
    color: white;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    font-size: 0.8rem;
}

.image-options button:hover {
    background: rgba(0,0,0,0.5);
}

.image-options .icon {
    font-size: 1rem;
}

/* Style untuk toggle switch */
.toggle-box {
    position: relative;
    display: inline-block;
    width: 40px;
    height: 20px;
    margin-left: 8px;
}

.toggle-box input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #555;
    transition: .2s;
    border-radius: 20px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 16px;
    width: 16px;
    left: 2px;
    bottom: 2px;
    background-color: white;
    transition: .2s;
    border-radius: 50%;
}

input:checked + .slider {
    background-color: var(--primary-color);
}

input:checked + .slider:before {
    transform: translateX(20px);
}

/* Style untuk input number yang lebih baik */
.size-input {
    width: 50px;
    padding: 4px;
    background: #222;
    border: 1px solid #444;
    color: #eee;
    border-radius: 4px;
    text-align: center;
    font-size: 12px;
}

.size-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 1px var(--primary-color);
}

.footer-note {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(0, 0, 0, 0.8);
    padding: 15px 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-top: 1px solid rgba(255,255,255,0.1);
    backdrop-filter: blur(5px);
    font-family: "Exo 2", sans-serif;
}

.footer-text {
    font-weight: 300;
    font-style: italic;
    color: rgba(255,255,255,0.7);
    font-size: 0.9rem;
    position: static;
}

.social-links {
    display: flex;
    gap: 15px;
}

.social-link {
    color: rgba(255,255,255,0.7);
    text-decoration: none;
    transition: all 0.3s ease;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 5px;
}

.social-link:hover {
    color: var(--primary-color);
    transform: translateY(-2px);
}

.social-link i {
    font-size: 1.2rem;
}

.mockup-container {
    position: relative;
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: center;
}

.size-box-wrapper {
    position: absolute;
    right: 0;
    top: 0;
    height: 100%;
    display: flex;
    align-items: flex-start;
    padding: 10px;
    z-index: 10;
}

.size-box-scrollable {
    max-height: 100%;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: var(--primary-color) var(--background-elevated-2);
}

.size-box-scrollable::-webkit-scrollbar {
    width: 4px;
}

.size-box-scrollable::-webkit-scrollbar-track {
    background: var(--background-elevated-2);
    border-radius: 2px;
}

.size-box-scrollable::-webkit-scrollbar-thumb {
    background-color: var(--primary-color);
    border-radius: 2px;
}
.splash-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--background-color);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    opacity: 1;
    visibility: visible;
    transition: all 1s ease-out;
    animation: fadeOut 2s 2s forwards;
}

.splash-screen.hide {
    opacity: 0;
    visibility: hidden;
}

.splash-content {
    text-align: center;
    transform: translateY(-20px);
    animation: slideUp 0.5s ease-out forwards;
}

.splash-content h1 {
    font-size: 3.5rem;
    color: var(--primary-color);
    margin-bottom: 1rem;
    text-transform: uppercase;
    letter-spacing: 2px;
}

.splash-content p {
    font-size: 1.5rem;
    color: var(--text-secondary);
    margin-bottom: 2rem;
}

.loading-bar {
    width: 200px;
    height: 3px;
    background: rgba(255,255,255,0.1);
    margin: 0 auto;
    position: relative;
    overflow: hidden;
}

.loading-bar::after {
    content: '';
    position: absolute;
    left: -50%;
    width: 40%;
    height: 100%;
    background: var(--primary-color);
    animation: loading 2s ease-in-out infinite;
}

@keyframes fadeOut {
    from {
        opacity: 1;
        visibility: visible;
    }
    to {
        opacity: 0;
        visibility: hidden;
    }
}

@keyframes slideUp {
    from {
        transform: translateY(-20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

@keyframes loading {
    0% {
        left: -40%;
    }
    100% {
        left: 120%;
    }
}
.saved-designs-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    z-index: 2000;
    padding: 20px;
    box-sizing: border-box;
    overflow-y: auto;
}

.saved-designs-content {
    background: var(--background-elevated);
    max-width: 90%;
    width: 900px;
    margin: 40px auto;
    padding: 30px;
    border-radius: var(--border-radius);
    color: white;
    box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.05);
}

.saved-designs-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.saved-design-item {
    background: var(--background-elevated-2);
    border-radius: var(--border-radius);
    padding: 15px;
    cursor: pointer;
    transition: var(--transition);
    border: 1px solid rgba(255,255,255,0.1);
}

.saved-design-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.3);
}

.saved-design-thumbnail {
    width: 100%;
    height: 150px;
    object-fit: contain;
    background: var(--background-color);
    border-radius: 8px;
    margin-bottom: 10px;
}

.saved-design-meta {
    font-size: 0.8rem;
    color: var(--text-secondary);
}

.saved-design-actions {
    display: flex;
    justify-content: space-between;
    margin-top: 10px;
}

.save-design-btn {
    background: #27ae60;
    margin-top: 6px;
    width: 100%;
    display: -webkit-box;
}

.save-design-btn:hover {
    background: #219a52;
}

.design-name-input {
    width: 100%;
    padding: 10px;
    margin: 10px 0;
    background: rgba(0,0,0,0.3);
    border: 1px solid var(--primary-color);
    border-radius: 6px;
    color: white;
    font-size: 1rem;
}
    </style>
</head>
<body>
    <div class="splash-screen">
        <div class="splash-content">
            <h1>Selamat Datang</h1>
            <p>di Aplikasi Custom T-Shirt Pricing</p>
            <p2>by. kanvas merchandise</p2>
            <div class="loading-bar"></div>
        </div>
    </div>
    <div class="studio-container">
        <div class="controls-panel">
            <h2>APLIKASI CUSTOM TSHIRT PRICING</h2>
            <h3>BY. KANVAS MERCH</h3>
            <div class="controls-section">
                <h3>üé® Warna Kaos</h3>
                <div class="color-options">
                    <div class="color-swatch selected" data-color="white" style="background:#ffffff" data-sleeve="short"></div>
                    <div class="color-swatch" data-color="black" style="background:#000000" data-sleeve="short"></div>
                    <div class="color-swatch" data-color="red" style="background:#ff0000" data-sleeve="short"></div>
                    <div class="color-swatch" data-color="navyblue" style="background:#223152" data-sleeve="short"></div>
                    <div class="color-swatch" data-color="grey" style="background:#808080" data-sleeve="short"></div>
                </div>
                
                <div class="input-group" style="margin-top:15px;">
                    <label>Model Lengan:
                        <select id="sleeveType" class="sleeve-select">
                            <option value="short">Pendek</option>
                            <option value="long">Panjang</option>
                        </select>
                    </label>
                </div>
            </div>
            
            <div class="controls-section">
                <h3>Upload Desain</h3>
                <input type="file" id="uploadFront" accept="image/*">
                <input type="file" id="uploadBack" accept="image/*">
                <button onclick="uploadFront.click()">üìÅ Depan</button>
                <button onclick="uploadBack.click()">üìÅ Belakang</button>
            </div>
            
            <div class="controls-section">
                <div class="section-header" onclick="togglePriceSettings()">
                    <h3>‚öôÔ∏è Pengaturan Harga</h3>
                    <span class="collapse-icon">‚ñº</span>
                </div>
                <div class="section-content" id="priceSettings">
                    <div class="input-group">
                        <label>Harga per cm¬≤:
                            <input type="number" id="pricePerCm" value="20" class="locked-input" readonly>
                        </label>
                    </div>
                    <div class="input-group">
                        <label>Harga Kaos:
                            <input type="number" id="basePrice" value="40000" class="locked-input" readonly>
                        </label>
                    </div>
                    <div class="input-group">
                        <label>Biaya Desain:
                            <input type="number" id="designFee" value="0" class="locked-input" readonly>
                        </label>
                    </div>
                    <button class="admin-btn" onclick="showLoginModal()">üîë Ubah Harga Dasar</button>
                </div>
            </div>

            <div class="login-modal" id="loginModal">
                <div class="login-box">
                    <h3>Login Admin</h3>
                    <p>Masukkan password untuk mengubah harga:</p>
                    <input type="password" id="adminPassword" placeholder="Password">
                    <div class="error-message" id="loginError">Password salah!</div>
                    <button onclick="checkAdminPassword()">Masuk</button>
                    <button class="secondary" onclick="closeLoginModal()">Batal</button>
                </div>
            </div>
            <div class="price-display">
                <div class="price-total">
                    <div class="total-label">TOTAL HARGA</div>
                    <div class="total-amount" id="totalPrice">Rp 0</div>
                </div>

                <div class="price-header">
                    <div class="price-icon">üíµ</div>
                    <h3>RINCIAN HARGA</h3>
                </div>
                
                <div class="price-items">
                    <div class="price-item">
                        <span class="price-label">Kaos Polos</span>
                        <span class="price-value" id="basePriceDisplay">Rp 0</span>
                    </div>
                    <div class="price-item" id="frontPriceItem">
                        <span class="price-label">Sablon Depan</span>
                        <span class="price-value" id="frontPriceDisplay">-</span>
                    </div>
                    <div class="price-item" id="backPriceItem">
                        <span class="price-label">Sablon Belakang</span>
                        <span class="price-value" id="backPriceDisplay">-</span>
                    </div>
                    <div class="price-item">
                        <span class="price-label">Biaya Desain</span>
                        <span class="price-value" id="designFeeDisplay">Free</span>
                    </div>
                </div>
                
                <button class="preview-btn" onclick="showPreview()">
                    <span class="btn-icon">üëÅÔ∏è</span>
                    <span class="btn-text">PREVIEW DESAIN</span>
                </button>
            </div>
            <div class="controls-section">
                <h3>üíæ Simpan Desain</h3>
                <input type="text" id="designName" class="design-name-input" placeholder="Nama Desain">
                <button class="save-design-btn" onclick="saveDesign()">
                    <i class="fas fa-save"></i> SIMPAN DESAIN
                </button>
                <button onclick="showSavedDesigns()" style="margin-top:10px;display: flow;">
                    <i class="fas fa-folder-open"></i> LIHAT DESAIN TERSIMPAN
                </button>
            </div>
        </div>
        <div class="design-canvas">
            <div class="mockup-frame" id="frame-front">
                <div class="mockup-container">
                    <img id="mockup-front" class="mockup" src="https://i.imgur.com/kXuLU9B.jpeg" crossorigin="anonymous">
                    <div class="overlay-container" id="overlay-container-front"></div>
                    <div class="size-box-wrapper" id="size-box-wrapper-front"></div>
                </div>
            </div>
            <div class="mockup-frame" id="frame-back">
                <div class="mockup-container">
                    <img id="mockup-back" class="mockup" src="https://i.imgur.com/hUyJtaF.jpeg" crossorigin="anonymous">
                    <div class="overlay-container" id="overlay-container-back"></div>
                    <div class="size-box-wrapper" id="size-box-wrapper-back"></div>
                </div>
            </div>
        </div>
        <div class="footer-note">
            <div class="footer-text">
                All right reserved | Kanvas Merchandise - Workshop: Jl. Riau Barat No.21, Kec. Sananwetan, Kota Blitar
            </div>
            <div class="social-links">
                <a href="https://wa.me/6282257423324" class="social-link" target="_blank">
                    <i class="fab fa-whatsapp"></i>
                    <span>082257423324</span>
                </a>
                <a href="https://instagram.com/kanvas.merch" class="social-link" target="_blank">
                    <i class="fab fa-instagram"></i>
                    <span>kanvas.merch</span>
                </a>
                <a href="https://tiktok.com/@kanvasmerch" class="social-link" target="_blank">
                    <i class="fab fa-tiktok"></i>
                    <span>kanvasmerch</span>
                </a>
            </div>
        </div>
    </div>

    <div class="saved-designs-modal" id="savedDesignsModal">
        <div class="saved-designs-content">
            <span class="close-btn" onclick="closeSavedDesigns()">&times;</span>
            <h2><i class="fas fa-folder-open"></i> Desain Tersimpan</h2>
            
            <div class="saved-designs-grid" id="savedDesignsGrid">
                <!-- Designs will be loaded here -->
            </div>
        </div>
    </div>

    <div class="crop-modal" id="cropModal">
        <div class="crop-container">
            <div id="cropImageContainer" style="position:relative"></div>
            <div style="text-align:center; margin-top:20px;">
               
            </div>
        </div>
    </div>

    <div class="preview-modal">
        <div class="preview-content">
            <span class="close-btn" onclick="closePreview()">&times;</span>
            <h2>Preview Desain</h2>
            
            <div class="preview-images">
                <div class="preview-image">
                    <h4>Depan</h4>
                    <img id="preview-front-img">
                </div>
                <div class="preview-image">
                    <h4>Belakang</h4>
                    <img id="preview-back-img">
                </div>
            </div>

            <div class="price-summary">
                <h3 style="margin-bottom:15px;color:var(--primary-color);border-bottom:1px solid rgba(255,255,255,0.1);padding-bottom:10px;">
                    üìã Rincian Biaya
                </h3>
                
                <div class="price-detail">
                    <div class="price-row">
                        <span class="price-label">Kaos Polos</span>
                        <span class="price-value" id="preview-base-price">Rp 0</span>
                    </div>
                    
                    <div class="price-row" id="preview-front-row">
                        <span class="price-label">Sablon Depan <span class="size-info" id="preview-front-size"></span></span>
                        <span class="price-value" id="preview-front-price">-</span>
                    </div>
                    
                    <div class="price-row" id="preview-back-row">
                        <span class="price-label">Sablon Belakang <span class="size-info" id="preview-back-size"></span></span>
                        <span class="price-value" id="preview-back-price">-</span>
                    </div>
                    
                    <div class="price-row">
                        <span class="price-label">Biaya Desain</span>
                        <span class="price-value" id="preview-design-fee">Free</span>
                    </div>
                </div>
                
                <div class="price-total">
                    <div class="total-label">TOTAL HARGA SATUAN</div>
                    <div class="total-amount" id="preview-total-price">Rp 0</span>
                </div>
            </div>

            <div class="preview-actions">
                <button onclick="downloadExactPreview()">‚¨á Unduh Desain Saja</button>
                <button onclick="downloadCombinedPreview()">‚¨á Unduh Desain + Harga</button>
                
            </div>
        </div>
    </div>
    
    <div id="preview-download-area" style="display:none;">
        <div id="preview-download-header">
            <span>üñºÔ∏è</span>
            <span>Preview Desain Kaos Custom</span>
        </div>
        <div id="preview-download-images">
            <div>
                <h4>Depan</h4>
                <img id="preview-download-front">
            </div>
            <div>
                <h4>Belakang</h4>
                <img id="preview-download-back">
            </div>
        </div>
        <div id="preview-download-prices">
            <h3 style="color: var(--primary-color); margin-top: 0; display: flex; align-items: center; gap: 8px;">
                <span>üßæ</span>
                <span>Rincian Harga</span>
            </h3>
            <div id="price-download-details"></div>
        </div>
        <div id="preview-download-total"></div>
    </div>

 


<script>

// Initialize Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAS2pAiyfpEJjaZKTxiS41078UrpBfMpXQ",
  authDomain: "studiodesainsablon.firebaseapp.com",
  databaseURL: "https://studiodesainsablon-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "studiodesainsablon",
  storageBucket: "studiodesainsablon.firebasestorage.app",
  messagingSenderId: "672894480603",
  appId: "1:672894480603:web:6003ad53058c3d4b259cfe",
  measurementId: "G-1H5W7B8F6W"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

let currentDesignId = null;

//INPUT WARNA KAOS
    const colorData = {
        white: {
            short: {
                front: 'https://i.imgur.com/kXuLU9B.jpeg',
                back: 'https://i.imgur.com/hUyJtaF.jpeg'
            },
            long: {
                front: 'https://i.imgur.com/XIPmA9f.jpeg',
                back: 'https://i.imgur.com/Xc7DXCN.jpeg'
            }
        },
        black: {
            short: {
                front: 'https://i.imgur.com/IkCWJ36.jpeg',
                back: 'https://i.imgur.com/0xVvoQN.jpeg'
            },
            long: {
                front: 'https://i.imgur.com/zeO3yPX.jpeg',
                back: 'https://i.imgur.com/1Zgey6R.jpeg'
            }
        },
        red: {
            short: {
                front: 'https://i.imgur.com/LOyOlVq.jpeg',
                back: 'https://i.imgur.com/5URYLlI.jpeg'
            },
            long: {
                front: 'https://i.imgur.com/PoZw4T8.jpeg',
                back: 'https://i.imgur.com/nONwGpc.jpeg'
            }
        },
        navyblue: {
            short: {
                front: 'https://i.imgur.com/iwEUANU.jpeg',
                back: 'https://i.imgur.com/hL2zqOk.jpeg'
            },
            long: {
                front: 'https://i.imgur.com/IJHOODo.jpeg',
                back: 'https://i.imgur.com/pUJDUvo.jpeg'
            }
        }
    };
    
    let currentColor = 'white';
    const uploadFront = document.getElementById('uploadFront');
    const uploadBack = document.getElementById('uploadBack');
    const mockups = { front: document.getElementById('mockup-front'), back: document.getElementById('mockup-back') };
    const containers = { front: document.getElementById('overlay-container-front'), back: document.getElementById('overlay-container-back') };
    const sizeBoxWrappers = { front: document.getElementById('size-box-wrapper-front'), back: document.getElementById('size-box-wrapper-back') };
    const transforms = { front: {}, back: {} };

    document.getElementById('sleeveType').addEventListener('change', function() {
        updateMockupImage();
        updatePrice();
    });

    document.querySelectorAll('.color-swatch').forEach(s => s.addEventListener('click', () => {
        document.querySelectorAll('.color-swatch').forEach(e => e.classList.remove('selected'));
        s.classList.add('selected'); 
        currentColor = s.dataset.color; 
        updateMockupImage();
    }));

    uploadFront.addEventListener('change', e => handleUpload(e, 'front'));
    uploadBack.addEventListener('change', e => handleUpload(e, 'back'));

    ['pricePerCm','basePrice','designFee'].forEach(id => {
        const input = document.getElementById(id);
        input.addEventListener('input', function() {
            if (isAdmin) {
                updatePrice();
            } else {
                this.value = this.defaultValue;
            }
        });
    });

    function handleUpload(e, side) {
        const file = e.target.files[0]; 
        if (!file) return;
        const reader = new FileReader(); 
        reader.onload = ev => createOverlay(ev.target.result, side);
        reader.readAsDataURL(file); 
        e.target.value = '';
    }

    function createOverlay(src, side) {
        const el = document.createElement('img');
        el.src = src;
        el.className = 'design-overlay';
        containers[side].appendChild(el);
        
        applyImageFilters(el, transforms[side] || { inverted: false });
        
        initOverlay(el, side);
    }

    function initOverlay(el, side) {
    // Stop previous interaction if exists
    if (transforms[side]?.interactable) {
        transforms[side].interactable.unset();
    }

    // Initialize default values if not set
    transforms[side] = transforms[side] || {};
    transforms[side].x = transforms[side].x || 0;
    transforms[side].y = transforms[side].y || 0;
    transforms[side].width = transforms[side].width || 0;
    transforms[side].height = transforms[side].height || 0;
    transforms[side].angle = transforms[side].angle || 0;
    transforms[side].proportional = transforms[side].proportional !== undefined ? transforms[side].proportional : true;
    transforms[side].inverted = transforms[side].inverted || false;
    transforms[side].blendMode = transforms[side].blendMode || 'normal';

    el.onload = () => {
        const cont = containers[side];
        transforms[side].ar = el.naturalWidth / el.naturalHeight;

        // Set default size if not already set
        if (!transforms[side].width || !transforms[side].height) {
            const w = Math.min(cont.offsetWidth * 0.7, 300);
            transforms[side].width = w;
            transforms[side].height = w / transforms[side].ar;
            centerOverlay(side);
        }

        // Create size box if not exists
        if (!transforms[side].box) {
            createSizeBox(side);
        }
        
        // Initialize interactivity
        transforms[side].interactable = interact(el);
        applyInteractOptions(side);
        update(el, side);
        updatePrice();
    };
}

    function createSizeBox(side) {
    // HAPUS DULU SEMUA SIZE BOX YANG ADA
    sizeBoxWrappers[side].innerHTML = '';
    
    const box = document.createElement('div');
    box.className = 'size-box-container';
    sizeBoxWrappers[side].appendChild(box);
    transforms[side].box = box;
    updateBox(side);
}

    function applyInteractOptions(side) {
        const el = containers[side].querySelector('.design-overlay');
        const t = transforms[side];

        if (!el || !t || !t.interactable) return;

        const interactable = t.interactable;
        interactable.unset();

        interact(el)
            .draggable({
                listeners: {
                    move(ev) {
                        t.x += ev.dx;
                        t.y += ev.dy;
                        update(el, side);
                    }
                }
            })
            .resizable({
                edges: { left: true, right: true, top: true, bottom: true },
                modifiers: [
                    interact.modifiers.aspectRatio({
                        ratio: t.proportional ? t.ar : 'preserve',
                        enabled: t.proportional
                    })
                ],
                listeners: {
                    move(ev) {
                        t.width = ev.rect.width;
                        t.height = ev.rect.height;
                        t.x += ev.deltaRect.left;
                        t.y += ev.deltaRect.top;
                        update(el, side);
                    }
                }
            })
            .gesturable({
                listeners: {
                    move(ev) {
                        t.angle += ev.da;
                        update(el, side);
                    }
                }
            });

        t.interactable = interactable;
    }

    function update(el, side) {
        const t = transforms[side]; 
        el.style.transform = `translate(${t.x}px,${t.y}px) rotate(${t.angle}deg)`;
        el.style.width = t.width + 'px'; 
        el.style.height = t.height + 'px'; 
        updateBox(side);
    }

    function updateBox(side) {
        const t = transforms[side];
        const cont = containers[side];
        const box = t.box;
        if (!box) return;

        const wCm = (t.width / cont.offsetWidth) * 104;
        const hCm = (t.height / cont.offsetHeight) * 104;
        const isCollapsed = box.classList.contains('collapsed');

        box.innerHTML = `
        <div class="size-box-header" onclick="toggleSizeBox('${side}')">
            <span>Edit Design</span>
            <span class="collapse-icon">‚ñº</span>
        </div>
        <div class="size-box-content" style="${isCollapsed ? 'display:none' : ''}">
            <div class="size-box-header">
                <span>Edit Design</span>
            </div>
            
            <div class="size-box-grid">
                <div class="size-input-group">
                    <label>Width (cm):</label>
                    <input type="number" step="0.1" value="${wCm.toFixed(1)}" id="widthInput-${side}">
                </div>
                <div class="size-input-group">
                    <label>Height (cm):</label>
                    <input type="number" step="0.1" value="${hCm.toFixed(1)}" id="heightInput-${side}">
                </div>
                
                <div class="position-controls">
                    <div class="position-row">
                        <button class="btn-nav" onclick="moveOverlay('${side}', 0, -10)">‚Üë</button>
                    </div>
                    <div class="position-row">
                        <button class="btn-nav" onclick="moveOverlay('${side}', -10, 0)">‚Üê</button>
                        <button class="btn-nav btn-center" onclick="centerOverlay('${side}')">‚óã</button>
                        <button class="btn-nav" onclick="moveOverlay('${side}', 10, 0)">‚Üí</button>
                    </div>
                    <div class="position-row">
                        <button class="btn-nav" onclick="moveOverlay('${side}', 0, 10)">‚Üì</button>
                    </div>
                </div>
                
                <div class="advanced-options">
                    <label class="option-checkbox">
                        <input type="checkbox" ${t.proportional ? 'checked' : ''} 
                               onchange="toggleProportional('${side}', this.checked)">
                        Lock Aspect Ratio
                    </label>
                    
                    <div class="blend-mode-selector">
                        <label>Blend Mode:</label>
                        <select onchange="updateBlendMode('${side}', this.value)">
                            <option value="normal" ${t.blendMode === 'normal' ? 'selected' : ''}>Normal</option>
                            <option value="multiply" ${t.blendMode === 'multiply' ? 'selected' : ''}>Multiply</option>
                            <option value="screen" ${t.blendMode === 'screen' ? 'selected' : ''}>Screen</option>
                            <option value="overlay" ${t.blendMode === 'overlay' ? 'selected' : ''}>Overlay</option>
                        </select>
                    </div>                 
                    <button class="btn-invert ${t.inverted ? 'active' : ''}" 
                            onclick="toggleInvert('${side}')">
                        ${t.inverted ? '‚òÄÔ∏è Original Colors' : 'üåë Invert Colors'}
                    </button>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn-action" onclick="rotateOverlay('${side}', 90)">
                    <span class="icon">‚Üª</span> Rotate
                </button>
                <button class="btn-action" onclick="startCrop('${side}')">
                    <span class="icon">‚úÇÔ∏è</span> Crop
                </button>
                <button class="btn-action btn-delete" onclick="deleteOverlay('${side}')">
                    <span class="icon">üóëÔ∏è</span> Delete
                </button>
            </div>
            
            <button class="size-box-confirm-btn" onclick="confirmSizeChange('${side}')">UPDATE</button>
        `;

        if (isCollapsed) {
        box.classList.add('collapsed');
    }

        setupInputControls(side);
    }

    function toggleSizeBox(side) {
    const t = transforms[side];
    if (!t.box) return;
    
    t.box.classList.toggle('collapsed');
    const content = t.box.querySelector('.size-box-content');
    if (t.box.classList.contains('collapsed')) {
        content.style.display = 'none';
    } else {
        content.style.display = 'block';
    }
}

    function setupInputControls(side) {
        const widthInput = document.getElementById(`widthInput-${side}`);
        const heightInput = document.getElementById(`heightInput-${side}`);
        
        if (widthInput && heightInput) {
            widthInput.addEventListener('change', () => applySizeFromInput(side, 'width'));
            heightInput.addEventListener('change', () => applySizeFromInput(side, 'height'));
            
            widthInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') applySizeFromInput(side, 'width');
            });
            heightInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') applySizeFromInput(side, 'height');
            });
        }
    }

    function applySizeFromInput(side, dimension) {
        const input = document.getElementById(`${dimension}Input-${side}`);
        const value = parseFloat(input.value) || 0;
        const cont = containers[side];
        const t = transforms[side];

        if (dimension === 'width') {
            t.width = (value / 104) * cont.offsetWidth;
            if (t.proportional) {
                t.height = t.width / t.ar;
                const heightInput = document.getElementById(`heightInput-${side}`);
                if (heightInput) heightInput.value = (t.height / cont.offsetHeight * 104).toFixed(1);
            }
        } else {
            t.height = (value / 104) * cont.offsetHeight;
            if (t.proportional) {
                t.width = t.height * t.ar;
                const widthInput = document.getElementById(`widthInput-${side}`);
                if (widthInput) widthInput.value = (t.width / cont.offsetWidth * 104).toFixed(1);
            }
        }

        const overlay = cont.querySelector('.design-overlay');
        if (overlay) {
            update(overlay, side);
        }
    }

    function confirmSizeChange(side) {
        const widthInput = document.getElementById(`widthInput-${side}`);
        const heightInput = document.getElementById(`heightInput-${side}`);
        const cont = containers[side];
        const t = transforms[side];

        const widthCm = parseFloat(widthInput.value) || 0;
        const heightCm = parseFloat(heightInput.value) || 0;

        t.width = (widthCm / 104) * cont.offsetWidth;
        t.height = (heightCm / 104) * cont.offsetHeight;

        const overlay = cont.querySelector('.design-overlay');
        update(overlay, side);
        updatePrice();

        const btn = t.box.querySelector('.size-box-confirm-btn');
        if (btn) {
            btn.textContent = '‚úì UPDATED';
            setTimeout(() => {
                btn.textContent = 'UPDATE';
            }, 1000);
        }
    }

    function moveOverlay(side, dx, dy) {
        const t = transforms[side];
        t.x += dx;
        t.y += dy;
        update(containers[side].querySelector('.design-overlay'), side);
    }

    function toggleProportional(side, isProportional) {
        transforms[side].proportional = isProportional;
        applyInteractOptions(side);
        
        if (isProportional) {
            const cont = containers[side];
            const t = transforms[side];
            const widthInput = document.getElementById(`widthInput-${side}`);
            const heightInput = document.getElementById(`heightInput-${side}`);
            
            if (widthInput && heightInput) {
                const widthCm = parseFloat(widthInput.value) || 0;
                const heightCm = widthCm / t.ar;
                heightInput.value = heightCm.toFixed(1);
            }
        }
    }

    function toggleInvert(side) {
        const overlay = containers[side].querySelector('.design-overlay');
        if (overlay) {
            transforms[side].inverted = !transforms[side].inverted;
            applyImageFilters(overlay, transforms[side]);
            updateBox(side);
        }
    }

    function applyImageFilters(element, transform) {
        let filter = '';
        
        if (transform.inverted) {
            filter += 'invert(1) ';
        }
        
        if (transform.blendMode && transform.blendMode !== 'normal') {
            element.style.mixBlendMode = transform.blendMode;
        } else {
            element.style.mixBlendMode = 'normal';
        }
        
        element.style.filter = filter;
        element.style.opacity = transform.inverted ? '0.9' : '1';
    }

    function updateBlendMode(side, mode) {
        const overlay = containers[side].querySelector('.design-overlay');
        if (overlay) {
            transforms[side].blendMode = mode;
            overlay.style.mixBlendMode = mode;
            overlay.style.opacity = mode === 'normal' ? '1' : '0.9';
        }
    }

    let currentCropSide = null;
    let cropInteract = null;

    function startCrop(side) {
        currentCropSide = side;
    const overlay = containers[side].querySelector('.design-overlay');
    if (!overlay) return;

    // Periksa jika gambar sudah dimuat
    if (!overlay.complete || overlay.naturalWidth === 0) {
        overlay.onload = function() {
            startCrop(side); // Panggil lagi setelah gambar dimuat
        };
        return;
    }
        const container = document.getElementById('cropImageContainer');
        container.innerHTML = `
            <div class="crop-wrapper">
                <img src="${overlay.src}" id="cropImg" style="max-height:60vh">
                <div class="crop-box" id="cropBox"></div>
            </div>
            <div class="crop-controls">
                <div class="crop-input-group">
                    <span>Lebar:</span>
                    <input type="number" id="cropWidth" value="100" min="10">
                    <span>px</span>
                </div>
                <div class="crop-input-group">
                    <span>Tinggi:</span>
                    <input type="number" id="cropHeight" value="100" min="10">
                    <span>px</span>
                </div>
                <label class="crop-input-group">
                    <input type="checkbox" id="lockRatio" checked>
                    <span>Proporsional</span>
                </label>
                <button onclick="resetCrop()">Reset</button>
                <button onclick="applyCrop()">Terapkan</button>
                <button class="secondary" onclick="closeCrop()">Batal</button>
            </div>
        `;

        const cropBox = document.getElementById('cropBox');
        const img = document.getElementById('cropImg');
        
        const initSize = Math.min(img.width, img.height) * 0.3;
        cropBox.style.width = `${initSize}px`;
        cropBox.style.height = `${initSize}px`;
        cropBox.style.left = `${(img.width - initSize) / 2}px`;
        cropBox.style.top = `${(img.height - initSize) / 2}px`;
        
        syncCropInputs();
        
        cropInteract = interact(cropBox)
            .draggable({
                modifiers: [
                    interact.modifiers.restrict({
                        restriction: img,
                        endOnly: true
                    })
                ],
                listeners: {
                    move(event) {
                        const x = (parseFloat(cropBox.style.left) || 0) + event.dx;
                        const y = (parseFloat(cropBox.style.top) || 0) + event.dy;
                        cropBox.style.left = `${x}px`;
                        cropBox.style.top = `${y}px`;
                        syncCropInputs();
                    }
                }
            })
            .resizable({
                edges: { left: true, right: true, top: true, bottom: true },
                modifiers: [
                    interact.modifiers.restrictEdges({
                        restriction: img
                    }),
                    interact.modifiers.aspectRatio({
                        ratio: 1,
                        enabled: document.getElementById('lockRatio').checked
                    })
                ],
                listeners: {
                    move(event) {
                        Object.assign(cropBox.style, {
                            width: `${event.rect.width}px`,
                            height: `${event.rect.height}px`,
                            left: `${(parseFloat(cropBox.style.left) || 0) + event.deltaRect.left}px`,
                            top: `${(parseFloat(cropBox.style.top) || 0) + event.deltaRect.top}px`
                        });
                        syncCropInputs();
                    }
                }
            });

        document.getElementById('cropWidth').addEventListener('input', function() {
            if (document.getElementById('lockRatio').checked) {
                const height = this.value / (cropBox.offsetWidth / cropBox.offsetHeight);
                cropBox.style.height = `${height}px`;
                document.getElementById('cropHeight').value = Math.round(height);
            }
            cropBox.style.width = `${this.value}px`;
        });

        document.getElementById('cropHeight').addEventListener('input', function() {
            if (document.getElementById('lockRatio').checked) {
                const width = this.value * (cropBox.offsetWidth / cropBox.offsetHeight);
                cropBox.style.width = `${width}px`;
                document.getElementById('cropWidth').value = Math.round(width);
            }
            cropBox.style.height = `${this.value}px`;
        });

        document.getElementById('lockRatio').addEventListener('change', function() {
            cropInteract.resizable({
                modifiers: [
                    interact.modifiers.aspectRatio({
                        ratio: 1,
                        enabled: this.checked
                    })
                ]
            });
        });

        document.getElementById('cropModal').style.display = 'block';
    }

    function syncCropInputs() {
        const box = document.getElementById('cropBox');
        if (!box) return;
        
        document.getElementById('cropWidth').value = Math.round(box.offsetWidth);
        document.getElementById('cropHeight').value = Math.round(box.offsetHeight);
    }

    function resetCrop() {
        const img = document.getElementById('cropImg');
        const box = document.getElementById('cropBox');
        const size = Math.min(img.width, img.height) * 0.3;
        
        box.style.width = `${size}px`;
        box.style.height = `${size}px`;
        box.style.left = `${(img.width - size) / 2}px`;
        box.style.top = `${(img.height - size) / 2}px`;
        
        syncCropInputs();
    }

    function applyCrop() {
    const container = document.getElementById('cropImageContainer');
    const img = container.querySelector('#cropImg');
    const cropBox = container.querySelector('#cropBox');
    
    if (!img || !cropBox) return;

    const side = currentCropSide;
    const containerOverlay = containers[side];
    const existingOverlay = containerOverlay.querySelector('.design-overlay');
    
    if (!existingOverlay) return;

    // 1. HAPUS SIZE BOX YANG ADA SEBELUMNYA
    sizeBoxWrappers[side].innerHTML = '';
    
    // 2. HENTIKAN INTERAKSI SEBELUMNYA
    if (transforms[side].interactable) {
        transforms[side].interactable.unset();
    }

    const scaleX = img.naturalWidth / img.offsetWidth;
    const scaleY = img.naturalHeight / img.offsetHeight;
    
    const canvas = document.createElement('canvas');
    canvas.width = cropBox.offsetWidth * scaleX;
    canvas.height = cropBox.offsetHeight * scaleY;
    
    const ctx = canvas.getContext('2d');
    ctx.drawImage(
        img,
        cropBox.offsetLeft * scaleX,
        cropBox.offsetTop * scaleY,
        canvas.width,
        canvas.height,
        0, 0,
        canvas.width,
        canvas.height
    );

    // 3. UPDATE OVERLAY YANG SUDAH ADA
    existingOverlay.src = canvas.toDataURL();
    
    // 4. UPDATE TRANSFORM DATA DENGAN BENAR
    transforms[side] = {
        ...transforms[side], // Pertahankan properti yang ada
        width: (cropBox.offsetWidth / img.width) * containerOverlay.offsetWidth,
        height: (cropBox.offsetHeight / img.height) * containerOverlay.offsetHeight,
        ar: canvas.width / canvas.height,
        box: null // Reset box karena akan dibuat baru
    };
    
    // 5. BUAT SIZE BOX BARU (HANYA SATU KALI)
    createSizeBox(side);
    
    // 6. INISIALISASI ULANG INTERAKSI
    initOverlay(existingOverlay, side);
    
    closeCrop();
    updatePrice();
}

    function closeCrop() {
        document.getElementById('cropModal').style.display = 'none';
        if (cropInteract) cropInteract.unset();
        currentCropSide = null;
    }

    function rotateOverlay(side, degrees) {
        transforms[side].angle += degrees;
        update(document.querySelector(`#overlay-container-${side} .design-overlay`), side);
    }

    function deleteOverlay(side) {
        const container = containers[side];
        container.querySelector('.design-overlay')?.remove();
        sizeBoxWrappers[side].innerHTML = '';
        transforms[side] = {};
        updatePrice();
    }

    function centerOverlay(side) {
        const t = transforms[side];
    const cont = containers[side];
    t.x = (cont.offsetWidth - t.width) / 2;
    // t.y tetap tidak diubah agar vertikal tidak berubah
    update(document.querySelector(`#overlay-container-${side} .design-overlay`), side);
}

    function roundSablonPrice(price) {
        if (price < 10000) return 10000;
        const remainder = price % 1000;
        if (remainder <= 500) {
            return price - remainder;
        } else {
            return price + (1000 - remainder);
        }
    }

    function updatePrice() {
        const ppcm = parseFloat(document.getElementById('pricePerCm').value) || 0;
        const base = parseFloat(document.getElementById('basePrice').value) || 0;
        const fee = parseFloat(document.getElementById('designFee').value) || 0;
        
        let cf = 0, cb = 0;
        let frontSize = '', backSize = '';
        
        ['front','back'].forEach(side => {
            const t = transforms[side];
            if (t.width && t.height) {
                const cont = containers[side];
                const wCm = (t.width / cont.offsetWidth) * 104;
                const hCm = (t.height / cont.offsetHeight) * 104;
                const area = wCm * hCm;
                const cost = roundSablonPrice(area * ppcm);
                
                if(side === 'front') {
                    cf = cost;
                    frontSize = ` (${wCm.toFixed(1)}√ó${hCm.toFixed(1)} cm)`;
                } else {
                    cb = cost;
                    backSize = ` (${wCm.toFixed(1)}√ó${hCm.toFixed(1)} cm)`;
                }
            }
        });
        
        const total = base + fee + cf + cb;
        
        document.getElementById('basePriceDisplay').textContent = `Rp ${base.toLocaleString()}`;
        document.getElementById('frontPriceDisplay').textContent = cf ? `Rp ${cf.toLocaleString()}${frontSize}` : '-';
        document.getElementById('backPriceDisplay').textContent = cb ? `Rp ${cb.toLocaleString()}${backSize}` : '-';
        document.getElementById('designFeeDisplay').textContent = fee ? `Rp ${fee.toLocaleString()}` : 'Free';
        document.getElementById('designFeeDisplay').style.color = fee ? 'var(--accent-color)' : 'var(--success-color)';
        
        const totalElement = document.getElementById('totalPrice');
        totalElement.textContent = `Rp ${total.toLocaleString()}`;
        totalElement.style.transform = 'scale(1.1)';
        setTimeout(() => {
            totalElement.style.transform = 'scale(1)';
        }, 300);
        
        document.getElementById('frontPriceItem').style.display = cf ? 'flex' : 'none';
        document.getElementById('backPriceItem').style.display = cb ? 'flex' : 'none';
    }

    function showPreview() {
        const frontCanvas = generatePreviewCanvas('front');
        const backCanvas = generatePreviewCanvas('back');
        
        const frontPreview = document.getElementById('preview-front-img');
        const backPreview = document.getElementById('preview-back-img');
        
        frontPreview.src = frontCanvas.toDataURL();
        backPreview.src = backCanvas.toDataURL();
        
        frontPreview.onload = backPreview.onload = function() {
            const basePrice = parseFloat(document.getElementById('basePrice').value) || 0;
            const designFee = parseFloat(document.getElementById('designFee').value) || 0;
            const pricePerCm = parseFloat(document.getElementById('pricePerCm').value) || 0;
            
            document.getElementById('preview-base-price').textContent = `Rp ${basePrice.toLocaleString()}`;
            document.getElementById('preview-design-fee').textContent = designFee > 0 ? `Rp ${designFee.toLocaleString()}` : 'Free';
            document.getElementById('preview-design-fee').style.color = designFee > 0 ? 'var(--accent-color)' : 'var(--success-color)';

            let frontPrice = 0;
            let backPrice = 0;
            
            ['front', 'back'].forEach(side => {
                const t = transforms[side];
                if (t.width && t.height) {
                    const cont = containers[side];
                    const wCm = (t.width / cont.offsetWidth) * 104;
                    const hCm = (t.height / cont.offsetHeight) * 104;
                    const area = wCm * hCm;
                    const cost = roundSablonPrice(area * pricePerCm);
                    
                    document.getElementById(`preview-${side}-price`).textContent = `Rp ${cost.toLocaleString()}`;
                    document.getElementById(`preview-${side}-size`).textContent = `(${wCm.toFixed(1)}√ó${hCm.toFixed(1)} cm)`;
                    document.getElementById(`preview-${side}-row`).style.display = 'flex';

                    if (side === 'front') {
                        frontPrice = cost;
                    } else {
                        backPrice = cost;
                    }
                } else {
                    document.getElementById(`preview-${side}-row`).style.display = 'none';
                }
            });

            const total = basePrice + designFee + frontPrice + backPrice;
            document.getElementById('preview-total-price').textContent = `Rp ${total.toLocaleString()}`;
            
            document.querySelector('.preview-modal').style.display = 'block';
        };
    }

    function generatePreviewCanvas(side) {
        const mockup = document.getElementById(`mockup-${side}`);
        const overlay = document.querySelector(`#overlay-container-${side} .design-overlay`);
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        canvas.width = mockup.naturalWidth;
        canvas.height = mockup.naturalHeight;

        ctx.drawImage(mockup, 0, 0, canvas.width, canvas.height);

        if (overlay) {
            const t = transforms[side];
            const container = mockup.parentElement;

            const containerWidth = container.offsetWidth;
            const containerHeight = container.offsetHeight;
            const imageAspect = mockup.naturalWidth / mockup.naturalHeight;
            const containerAspect = containerWidth / containerHeight;

            let renderedWidth, renderedHeight, renderedLeft, renderedTop;
            if (imageAspect > containerAspect) {
                renderedWidth = containerWidth;
                renderedHeight = containerWidth / imageAspect;
            } else {
                renderedHeight = containerHeight;
                renderedWidth = containerHeight * imageAspect;
            }
            renderedLeft = (containerWidth - renderedWidth) / 2;
            renderedTop = (containerHeight - renderedHeight) / 2;

            const scaleX = renderedWidth / mockup.naturalWidth;
            const scaleY = renderedHeight / mockup.naturalHeight;

            const overlayCanvas = document.createElement('canvas');
            overlayCanvas.width = canvas.width;
            overlayCanvas.height = canvas.height;
            const overlayCtx = overlayCanvas.getContext('2d');

            const imageX = (t.x - renderedLeft) / scaleX;
            const imageY = (t.y - renderedTop) / scaleY;
            const imageWidth = t.width / scaleX;
            const imageHeight = t.height / scaleY;

            overlayCtx.save();
            overlayCtx.translate(imageX + imageWidth/2, imageY + imageHeight/2);
            overlayCtx.rotate(t.angle * Math.PI / 180);
            
            if (t.inverted) {
                overlayCtx.filter = 'invert(1)';
            } else {
                overlayCtx.filter = 'none';
            }
            
            overlayCtx.drawImage(
                overlay,
                -imageWidth/2,
                -imageHeight/2,
                imageWidth,
                imageHeight
            );
            overlayCtx.restore();

            ctx.save();
            if (t.blendMode && t.blendMode !== 'normal') {
                ctx.globalCompositeOperation = t.blendMode;
            }
            
            ctx.drawImage(overlayCanvas, 0, 0);
            ctx.restore();
        }

        return canvas;
    }

    async function downloadCombinedPreview() {
    const previewModal = document.querySelector('.preview-modal');
    const originalStyle = previewModal.style.cssText;
    
    try {
        // 1. Tampilkan modal dan pindahkan ke atas halaman
        previewModal.style.display = 'block';
        previewModal.style.position = 'fixed';
        previewModal.style.top = '0';
        previewModal.style.left = '0';
        previewModal.style.zIndex = '99999';
        previewModal.style.background = 'rgba(0,0,0,0.96)';
        previewModal.style.padding = '20px';
        
        // 2. Sembunyikan tombol download
        const downloadBtn = document.querySelector('.preview-actions');
        downloadBtn.style.display = 'none';
        
        // 3. Tunggu 500ms untuk render ulang
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // 4. Ambil konten preview
        const previewContent = document.querySelector('.preview-content');
        
        // 5. Atur ulang styling untuk kebutuhan capture
        previewContent.style.width = '900px';
        previewContent.style.margin = '0 auto';
        previewContent.style.padding = '30px';
        previewContent.style.boxSizing = 'border-box';
        
        // 6. Tambahkan padding ekstra untuk total harga
        const priceTotal = previewContent.querySelector('.price-total');
        priceTotal.style.paddingBottom = '40px';
        
        // 7. Capture dengan html2canvas
        const canvas = await html2canvas(previewContent, {
            scale: 1.5,
            logging: false,
            useCORS: true,
            scrollX: 0,
            scrollY: -window.scrollY,
            backgroundColor: '#252525',
            allowTaint: true,
            letterRendering: true,
            windowHeight: previewContent.scrollHeight + 200
        });
        
        // 8. Buat link download
        const link = document.createElement('a');
        link.download = `desain-kaos-${Date.now()}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();

    } catch (error) {
        console.error('Download error:', error);
        alert('Gagal mengunduh preview. Silakan coba lagi.');
    } finally {
        // 9. Reset semua perubahan
        previewModal.style.cssText = originalStyle;
        document.querySelector('.preview-actions').style.display = 'flex';
        const priceTotal = document.querySelector('.price-total');
        if(priceTotal) priceTotal.style.paddingBottom = '15px';
    }
}

    function closePreview() {
        document.querySelector('.preview-modal').style.display = 'none';
    }

    function updateMockupImage() {
        const sleeveType = document.getElementById('sleeveType').value;
        mockups.front.src = colorData[currentColor][sleeveType].front;
        mockups.back.src = colorData[currentColor][sleeveType].back;
        ['front','back'].forEach(side => {
            containers[side].innerHTML = '';
            sizeBoxWrappers[side].innerHTML = '';
            transforms[side] = {};
        });
    }

    let isAdmin = false;

    function showLoginModal() {
        document.getElementById('loginModal').style.display = 'flex';
        document.getElementById('adminPassword').focus();
    }

    function closeLoginModal() {
        document.getElementById('loginModal').style.display = 'none';
        document.getElementById('adminPassword').value = '';
        document.getElementById('loginError').style.display = 'none';
    }

    function checkAdminPassword() {
        const password = document.getElementById('adminPassword').value;
        const errorElement = document.getElementById('loginError');
        
        if (password === '123123') {
            isAdmin = true;
            unlockPriceInputs();
            closeLoginModal();
            document.querySelector('.admin-btn').textContent = 'üîì Mode Admin Aktif';
            document.querySelector('.admin-btn').style.background = 'linear-gradient(135deg, #00b09b, #96c93d)';
            setTimeout(() => {
                document.querySelector('.admin-btn').textContent = 'üîë Ubah Harga Dasar';
                document.querySelector('.admin-btn').style.background = 'linear-gradient(135deg, #ff5e62, #ff9966)';
            }, 3000);
        } else {
            errorElement.style.display = 'block';
            document.getElementById('adminPassword').value = '';
        }
    }

    function unlockPriceInputs() {
        const inputs = document.querySelectorAll('.locked-input');
        inputs.forEach(input => {
            input.readOnly = false;
            input.classList.remove('locked-input');
        });
    }

    function lockPriceInputs() {
        const inputs = document.querySelectorAll('#pricePerCm, #basePrice, #designFee');
        inputs.forEach(input => {
            input.readOnly = true;
            if (!input.classList.contains('locked-input')) {
                input.classList.add('locked-input');
            }
        });
    }

    function togglePriceSettings() {
        const content = document.getElementById('priceSettings');
        const icon = document.querySelector('.section-header .collapse-icon');
        
        content.classList.toggle('collapsed');
        icon.style.transform = content.classList.contains('collapsed') 
            ? 'rotate(180deg)' 
            : 'rotate(0deg)';
    }

    function downloadCombinedPreviewImages() {
    const frontImg = document.getElementById('preview-front-img');
    const backImg = document.getElementById('preview-back-img');
    
    // Pastikan gambar sudah dimuat
    Promise.all([loadImage(frontImg.src), loadImage(backImg.src)]).then(images => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // Hitung ukuran canvas
        const padding = 40;
        const imgWidth = Math.max(images[0].width, images[1].width);
        const imgHeight = Math.max(images[0].height, images[1].height);
        
        canvas.width = (imgWidth * 2) + (padding * 3);
        canvas.height = imgHeight + (padding * 2);
        
        // Background putih
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Gambar frame
        ctx.strokeStyle = '#e0e0e0';
        ctx.lineWidth = 2;
        ctx.strokeRect(10, 10, canvas.width-20, canvas.height-20);
        
        // Posisi gambar
        let xPos = padding;
        const yPos = padding;
        
        // Gambar depan
        ctx.drawImage(images[0], xPos, yPos);
        addTextLabel(ctx, 'DEPAN', xPos + (images[0].width/2), yPos + images[0].height + 15);
        
        // Gambar belakang
        xPos += images[0].width + padding;
        ctx.drawImage(images[1], xPos, yPos);
        addTextLabel(ctx, 'BELAKANG', xPos + (images[1].width/2), yPos + images[1].height + 15);
        
        // Download
        const link = document.createElement('a');
        link.download = `desain-kaos-${Date.now()}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
    });
}



function addTextLabel(ctx, text, x, y) {
    ctx.fillStyle = '#2c3e50';
    ctx.font = '18px "Exo 2"';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'top';
    ctx.fillText(text, x, y);
}

function downloadExactPreview() {
    const frontImg = document.getElementById('preview-front-img');
    const backImg = document.getElementById('preview-back-img');
    
    Promise.all([loadImage(frontImg.src), loadImage(backImg.src)]).then(images => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // Hitung ukuran canvas berdasarkan gambar aktual
        const gap = 0; // Jarak antar gambar
        canvas.width = images[0].width + images[1].width + gap;
        canvas.height = Math.max(images[0].height, images[1].height);
        
        // Gambar langsung tanpa background
        ctx.drawImage(images[0], 0, (canvas.height - images[0].height)/2); // Tengahkan vertikal
        ctx.drawImage(images[1], images[0].width + gap, (canvas.height - images[1].height)/2);
        
        // Download
        const link = document.createElement('a');
        link.download = `desain-kaos-${Date.now()}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
    });
}

// Fungsi loadImage tetap sama
function loadImage(src) {
    return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = src;
    });
}
    window.addEventListener('DOMContentLoaded', () => {
        document.getElementById('priceSettings').classList.add('collapsed');
        lockPriceInputs();
    });
    document.addEventListener('DOMContentLoaded', () => {
    const splashScreen = document.querySelector('.splash-screen');
    
    // Set timeout untuk hide splash screen
    setTimeout(() => {
        splashScreen.classList.add('hide');
        
        // Hapus element setelah animasi selesai
        setTimeout(() => {
            splashScreen.remove();
        }, 400);
    }, 600); // Tampilkan selama 2 detik
});

function saveDesign() {
    const designName = document.getElementById('designName').value.trim();
    if (!designName) {
        alert('Silakan beri nama untuk desain Anda');
        return;
    }

    // Generate a unique ID if this is a new design
    const designId = currentDesignId || generateId();
    
    // Prepare transform data, ensuring no NaN values
    const prepareTransformData = (side) => {
        const t = transforms[side] || {};
        return {
            x: t.x || 0,
            y: t.y || 0,
            width: t.width || 0,
            height: t.height || 0,
            angle: t.angle || 0,
            ar: t.ar || 1,
            proportional: t.proportional !== undefined ? t.proportional : true,
            inverted: t.inverted || false,
            blendMode: t.blendMode || 'normal'
        };
    };

    // Get all design data
    const designData = {
        name: designName,
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        color: currentColor,
        sleeveType: document.getElementById('sleeveType').value,
        pricePerCm: parseFloat(document.getElementById('pricePerCm').value) || 0,
        basePrice: parseFloat(document.getElementById('basePrice').value) || 0,
        designFee: parseFloat(document.getElementById('designFee').value) || 0,
        transforms: {
            front: prepareTransformData('front'),
            back: prepareTransformData('back')
        },
        images: {
            front: containers.front.querySelector('.design-overlay')?.src || '',
            back: containers.back.querySelector('.design-overlay')?.src || ''
        },
        priceDetails: {
            base: parseFloat(document.getElementById('basePrice').value) || 0,
            front: document.getElementById('frontPriceDisplay').textContent,
            back: document.getElementById('backPriceDisplay').textContent,
            fee: document.getElementById('designFeeDisplay').textContent,
            total: document.getElementById('totalPrice').textContent
        }
    };

    // Save to Firebase
    database.ref('designs/' + designId).set(designData)
        .then(() => {
            alert('Desain berhasil disimpan!');
            currentDesignId = designId;
        })
        .catch(error => {
            console.error('Error saving design:', error);
            alert('Gagal menyimpan desain: ' + error.message);
        });
}

function generateId() {
    return 'design-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
}

function showSavedDesigns() {
    const modal = document.getElementById('savedDesignsModal');
    const grid = document.getElementById('savedDesignsGrid');
    
    grid.innerHTML = '<div class="loading">Memuat desain...</div>';
    modal.style.display = 'block';
    
    // Load designs from Firebase
    database.ref('designs').once('value')
        .then(snapshot => {
            const designs = snapshot.val();
            grid.innerHTML = '';
            
            if (!designs) {
                grid.innerHTML = '<div class="no-designs">Belum ada desain tersimpan</div>';
                return;
            }
            
            Object.entries(designs).forEach(([id, design]) => {
                // Add null checks for all properties
                if (!design) return;
                
                const designItem = document.createElement('div');
                designItem.className = 'saved-design-item';
                designItem.innerHTML = `
                    <img src="${design.images?.front || 'https://via.placeholder.com/250x150?text=No+Image'}" 
                         class="saved-design-thumbnail">
                    <h4>${design.name || 'Unnamed Design'}</h4>
                    <div class="saved-design-meta">
                        <div>Warna: ${design.color || 'N/A'}</div>
                        <div>Lengan: ${design.sleeveType === 'short' ? 'Pendek' : 'Panjang'}</div>
                        <div>Total: ${design.priceDetails?.total || 'Rp 0'}</div>
                        <div>${design.timestamp ? new Date(design.timestamp).toLocaleString() : 'Unknown date'}</div>
                    </div>
                    <div class="saved-design-actions">
                        <button onclick="loadDesign('${id}', event)">
                            <i class="fas fa-eye"></i> Lihat
                        </button>
                        <button onclick="deleteDesign('${id}', event)" class="btn-delete">
                            <i class="fas fa-trash"></i> Hapus
                        </button>
                    </div>
                `;
                grid.appendChild(designItem);
            });
        })
        .catch(error => {
            console.error('Error loading designs:', error);
            grid.innerHTML = '<div class="error">Gagal memuat desain: ' + error.message + '</div>';
        });
}

function closeSavedDesigns() {
    document.getElementById('savedDesignsModal').style.display = 'none';
}

function loadDesign(id, event) {
    if (event) event.stopPropagation();
    
    database.ref('designs/' + id).once('value')
        .then(snapshot => {
            const design = snapshot.val();
            if (!design) {
                alert('Desain tidak ditemukan');
                return;
            }
            
            currentDesignId = id;
            document.getElementById('designName').value = design.name || '';
            
            // Safely set color
            if (design.color) {
                const colorSwatch = document.querySelector(`.color-swatch[data-color="${design.color}"]`);
                if (colorSwatch) colorSwatch.click();
            }
            
            // Safely set sleeve type
            if (design.sleeveType) {
                document.getElementById('sleeveType').value = design.sleeveType;
            }
            updateMockupImage();
            
            // Safely set prices
            if (typeof design.pricePerCm === 'number') {
                document.getElementById('pricePerCm').value = design.pricePerCm;
            }
            if (typeof design.basePrice === 'number') {
                document.getElementById('basePrice').value = design.basePrice;
            }
            if (typeof design.designFee === 'number') {
                document.getElementById('designFee').value = design.designFee;
            }
            
            // Clear existing overlays
            containers.front.innerHTML = '';
            containers.back.innerHTML = '';
            sizeBoxWrappers.front.innerHTML = '';
            sizeBoxWrappers.back.innerHTML = '';
            
            // Load front design if exists
            if (design.images?.front) {
                // Add error handling for image loading
                try {
                    createOverlay(design.images.front, 'front');
                    setTimeout(() => {
                        if (design.transforms?.front) {
                            transforms.front = {
                                ...(design.transforms.front || {}),
                                interactable: null,
                                box: null
                            };
                            const overlay = containers.front.querySelector('.design-overlay');
                            if (overlay) {
                                initOverlay(overlay, 'front');
                                update(overlay, 'front');
                            }
                        }
                    }, 500);
                } catch (e) {
                    console.error('Error loading front image:', e);
                }
            }
            
            // Load back design if exists
            if (design.images?.back) {
                try {
                    createOverlay(design.images.back, 'back');
                    setTimeout(() => {
                        if (design.transforms?.back) {
                            transforms.back = {
                                ...(design.transforms.back || {}),
                                interactable: null,
                                box: null
                            };
                            const overlay = containers.back.querySelector('.design-overlay');
                            if (overlay) {
                                initOverlay(overlay, 'back');
                                update(overlay, 'back');
                            }
                        }
                    }, 500);
                } catch (e) {
                    console.error('Error loading back image:', e);
                }
            }
            
            // Update price display
            setTimeout(updatePrice, 1000);
            
            closeSavedDesigns();
        })
        .catch(error => {
            console.error('Error loading design:', error);
            alert('Gagal memuat desain: ' + error.message);
        });
}

function deleteDesign(id, event) {
    if (event) event.stopPropagation();
    
    if (!confirm('Apakah Anda yakin ingin menghapus desain ini?')) {
        return;
    }
    
    database.ref('designs/' + id).remove()
        .then(() => {
            // Refresh the list
            showSavedDesigns();
        })
        .catch(error => {
            console.error('Error deleting design:', error);
            alert('Gagal menghapus desain: ' + error.message);
        });
}

    updateMockupImage();
</script>
</body>
</html>
